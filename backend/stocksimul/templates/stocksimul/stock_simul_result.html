{% extends 'stocksimul/base.html' %}
<!--{% load static %}-->
{% load stocksimul_tt %}

{% block content %}
<div class="result header">
    <div class="row">
        <div class="col-md-8">
            <br/>
            <br/>
            <h1>주식 시뮬레이션 차트 결과</h1>
        </div>
    </div>
</div>

<!-- 직접 template data를 사용하여 출력 -->
<div id="container-1" class="chart">
    <script>
<!--    Highcharts.getJSON('https://demo-live-data.highcharts.com/aapl-ohlcv.json', function (data) {-->
        var ohlc = [],
            volume = [],
            dataLength = {{ gui_ohlc|length }}
            i = 0;
        {% for item in gui_whole %}
<!--            {{ forloop.counter0 }}-->
            ohlc.push([
                {{item.0}}, // date
                {{item.1}}, // open
                {{item.2}}, // high
                {{item.3}}, // low
                {{item.4}} // close
            ]);
            volume.push([
                {{item.0}}, // date
                {{item.5}} //the volume
            ]);
        {% endfor %}

        Highcharts.stockChart('container-1', {
        yAxis: [{
            labels: {
                align: 'left'
            },
            height: '80%',
            resize: {
                enabled: true
            }
        }, {
            labels: {
                align: 'left'
            },
            top: '80%',
            height: '20%',
            offset: 0
        }],
        tooltip: {
            shape: 'square',
            headerShape: 'callout',
            borderWidth: 0,
            shadow: false,
            positioner: function (width, height, point) {
                var chart = this.chart,
                    position;

                if (point.isHeader) {
                    position = {
                        x: Math.max(
                            // Left side limit
                            chart.plotLeft,
                            Math.min(
                                point.plotX + chart.plotLeft - width / 2,
                                // Right side limit
                                chart.chartWidth - width - chart.marginRight
                            )
                        ),
                        y: point.plotY
                    };
                } else {
                    position = {
                        x: point.series.chart.plotLeft,
                        y: point.series.yAxis.top - chart.plotTop
                    };
                }

                return position;
            }
        },
        series: [{
            type: 'ohlc',
            id: 'aapl-ohlc',
            name: 'AAPL Stock Price',
            data: ohlc
        }, {
            type: 'column',
            id: 'aapl-volume',
            name: 'AAPL Volume',
            data: volume,
            yAxis: 1
        }],
        responsive: {
            rules: [{
                condition: {
                    maxWidth: 800
                },
                chartOptions: {
                    rangeSelector: {
                        inputEnabled: false
                    }
                }
            }]
        }
        });
<!--        });-->
        console.log('container-1 end.')
    </script>
</div>


<!-- ajax 내부 url 통신을 사용하여 출력 -->
<div id="container-2" class="chart">
    <script>
    console.log('container-2 event_name = ', '{{event_name}}' )
    console.log('container-2 event_name = ', '{{start_date_str}}' )
    console.log('container-2 event_name = ', '{{end_date_str}}' )

    $.ajax({
        url : '{% url 'ajax_chart_data' %}',
        type: 'GET',
        data: {'event_name': '{{ event_name }}'
        , 'start_date_str':'{{ start_date_str }}','end_date_str':'{{ end_date_str }}'},
        success: function(data){

        console.log('ajax response data = ', data)
        console.log('ajax response data length = ', data.chart_data.length)
        console.log('ajax response chart data = ', data.chart_data)
        console.log('ajax response chart data 0 = ', data.chart_data[0])
        var ohlc = [],
            volume = [],
            dataLength = data.chart_data.length,
            i = 0;
        for (i; i < dataLength; i += 1) {
            ohlc.push([
                data.chart_data[i][0], // the date
                data.chart_data[i][1], // open
                data.chart_data[i][2], // high
                data.chart_data[i][3], // low
                data.chart_data[i][4] // close
            ]);

            volume.push([
                data.chart_data[i][0], // the date
                data.chart_data[i][5] // the volume
            ]);
        }

        Highcharts.stockChart('container-2', {
        yAxis: [{
            labels: {
                align: 'left'
            },
            height: '80%',
            resize: {
                enabled: true
            }
        }, {
            labels: {
                align: 'left'
            },
            top: '80%',
            height: '20%',
            offset: 0
        }],
        tooltip: {
            shape: 'square',
            headerShape: 'callout',
            borderWidth: 0,
            shadow: false,
            positioner: function (width, height, point) {
                var chart = this.chart,
                    position;

                if (point.isHeader) {
                    position = {
                        x: Math.max(
                            // Left side limit
                            chart.plotLeft,
                            Math.min(
                                point.plotX + chart.plotLeft - width / 2,
                                // Right side limit
                                chart.chartWidth - width - chart.marginRight
                            )
                        ),
                        y: point.plotY
                    };
                } else {
                    position = {
                        x: point.series.chart.plotLeft,
                        y: point.series.yAxis.top - chart.plotTop
                    };
                }

                return position;
            }
        },
        series: [{
            type: 'ohlc',
            id: 'aapl-ohlc',
            name: 'AAPL Stock Price',
            data: ohlc
        }, {
            type: 'column',
            id: 'aapl-volume',
            name: 'AAPL Volume',
            data: volume,
            yAxis: 1
        }],
        responsive: {
            rules: [{
                condition: {
                    maxWidth: 800
                },
                chartOptions: {
                    rangeSelector: {
                        inputEnabled: false
                    }
                }
            }]
        }
        });
        }
    });
    </script>
</div>


<!-- highchart 샘플 데이터를 받아와 출력 -->
<div id="container-3" class="chart">
    <script>
    console.log('container-3 start')
    Highcharts.getJSON('https://demo-live-data.highcharts.com/aapl-ohlcv.json', function (data) {
  // split the data set into ohlc and volume
    var ohlc = [],
    volume = [],
    dataLength = data.length,
    i = 0;
    console.log(data[1][0])
    console.log(data[1][1])
    console.log(data[1][2])
    console.log(data[1][3])
    console.log(data[1][4])
    console.log(typeof(data[1][0]))
    console.log(typeof(data[1][1]))
    console.log(typeof(data[1][2]))
    console.log(typeof(data[1][3]))
    console.log(typeof(data[1][4]))
  for (i; i < dataLength; i += 1) {
    ohlc.push([
      data[i][0], // the date
      data[i][1], // open
      data[i][2], // high
      data[i][3], // low
      data[i][4] // close
    ]);

    volume.push([
      data[i][0], // the date
      data[i][5] // the volume
    ]);
  }

  Highcharts.stockChart('container-3', {
    yAxis: [{
      labels: {
        align: 'left'
      },
      height: '80%',
      resize: {
        enabled: true
      }
    }, {
      labels: {
        align: 'left'
      },
      top: '80%',
      height: '20%',
      offset: 0
    }],
    tooltip: {
      shape: 'square',
      headerShape: 'callout',
      borderWidth: 0,
      shadow: false,
      positioner: function (width, height, point) {
        var chart = this.chart,
          position;

        if (point.isHeader) {
          position = {
            x: Math.max(
              // Left side limit
              chart.plotLeft,
              Math.min(
                point.plotX + chart.plotLeft - width / 2,
                // Right side limit
                chart.chartWidth - width - chart.marginRight
              )
            ),
            y: point.plotY
          };
        } else {
          position = {
            x: point.series.chart.plotLeft,
            y: point.series.yAxis.top - chart.plotTop
          };
        }

        return position;
      }
    },
    series: [{
      type: 'ohlc',
      id: 'aapl-ohlc',
      name: 'AAPL Stock Price',
      data: ohlc
    }, {
      type: 'column',
      id: 'aapl-volume',
      name: 'AAPL Volume',
      data: volume,
      yAxis: 1
    }],
    responsive: {
      rules: [{
        condition: {
          maxWidth: 800
        },
        chartOptions: {
          rangeSelector: {
            inputEnabled: false
          }
        }
      }]
    }
  });
});
    </script>
</div>

{% endblock %}